#!/bin/bash
set -euo pipefail

rm -rf ./composer.json ./composer.lock ./secret.key ./vendor ./error_logs.txt ./config.php

db_pass=$(openssl rand -base64 256)
sudo mariadb -u root -e "source db.sql;CREATE OR REPLACE USER tasks IDENTIFIED BY \"$db_pass\";GRANT ALL ON tasks_db.* TO tasks;"

sudo apt-get install composer 7zip mariadb-server php-mysql openssl

composer require lcobucci/jwt lcobucci/Clock ramsey/uuid

openssl rand -out secret.key -base64 256

printf "<?php\n// This file is automatically generated\n\ndeclare(strict_types=1);\n\nclass Config\n{\n" | tee -a config.php > /dev/null
printf "    public static string \$database_hostname = \"localhost\";\n" | tee -a config.php > /dev/null
printf "    public static string \$database_username = \"tasks\";\n" | tee -a config.php > /dev/null
printf "    public static string \$database_password = \"%s\";\n" "$db_pass" | tee -a config.php > /dev/null
printf "    public static string \$database_name = \"tasks_db\";\n" | tee -a config.php > /dev/null
printf "}\n" | tee -a config.php > /dev/null

printf "Add the following lines to the end of \"/etc/mysql/mariadb.cnf\":\n[mysqld]\nevent_scheduler = on\n"
printf "\nIf you edited the file run \"sudo systemctl restart mariadb\" (or your init system's equivalent)\n"
