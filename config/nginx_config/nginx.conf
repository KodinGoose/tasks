# These config file was originally generated with https://ssl-config.mozilla.org/
# Then this file was "merged" with debian's default configs from /etc/nginx

user www-data;
worker_processes auto;
worker_cpu_affinity auto;
pid /run/nginx.pid;
error_log /var/log/nginx/error.log;

events {
    worker_connections  1024;
    # multi_accept on;
}

http {
    client_max_body_size 16k;
    sendfile on;
    tcp_nopush on;
    types_hash_max_size 2048;
    server_tokens off; # Recommended practice is to turn this off
    gzip on;

    include mime.types;
    default_type application/octet-stream;

    access_log /var/log/nginx/access.log;

    server {
        listen localhost:443 ssl default_server;
        # listen 443 ssl default_server;
        # listen [::]:443 ssl default_server;

        charset utf-8;
        http2 on;
        add_header Strict-Transport-Security "max-age=63072000" always;
        ssl_certificate /var/www/tasks/tasks.pem;
        ssl_certificate_key /var/www/tasks/tasks.key;

        server_name tasks;

        # pass PHP scripts to FastCGI server
        location / {
            root /var/www/tasks/web_server;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $document_root/router.php;
            # Update this when newer versions of php-fpm release
            fastcgi_pass unix:/run/php/php8.4-fpm.sock;
        }

        location /resource/ {
            root /var/www/tasks/web_server;
            try_files $uri $uri/ /resource/index.html =404;
        }
    }

    # intermediate configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ecdh_curve X25519:prime256v1:secp384r1;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-CHACHA20-POLY1305;
    ssl_prefer_server_ciphers off;

    # see also ssl_session_ticket_key alternative to stateful session cache
    ssl_session_timeout 1d;
    ssl_session_cache shared:MozSSL:10m;  # about 40000 sessions

    # curl https://ssl-config.mozilla.org/ffdhe2048.txt > /path/to/dhparam
    ssl_dhparam "/var/www/tasks/dhparam";

    # # OCSP stapling
    # ssl_stapling on;
    # ssl_stapling_verify on;

    # # verify chain of trust of OCSP response using Root CA and Intermediate certs
    # # ssl_trusted_certificate /path/to/root_CA_cert_plus_intermediates;

    # # replace with the IP address of your resolver;
    # # async 'resolver' is important for proper operation of OCSP stapling
    # resolver 127.0.0.1;

    # If certificates are marked OCSP Must-Staple, consider managing the
    # OCSP stapling cache with an external script, e.g. certbot-ocsp-fetcher

    # HSTS
    server {
        listen localhost:80 default_server;
        # listen 80 default_server;
        # listen [::]:80 default_server;

        return 301 https://$host$request_uri;
    }
}
